Author: Nicole Carrero
Creation Date: 8/24/2020

Updated On: 3/18/2021
Updated By: Nicole Carrero

**User Component**

**Context**

- Problem: Existing users are not able to provision new users into the Server.  New users need a Name, Department, Email Address, Username, Password, and Confirm Password to validate the strength and format of the provided password.  Users should be able to change their passwords.  Administrators should be able to delete users as necessary when viewing a list of all current users.  Administrators should view pending users and approve or reject them.  Administrators should have the ability to invite a user into the organization.
- Requirements: Ensure that a user can be added to the Server with the necessary fields, validate the strength and format of the provided user password, and edit their passwords.  Ensure that an administrator is able to view a list of existing users to delete them and perform organization approvals for new users.

**Component Scope**

- In-Scope:
  - Users can be added to the Server with the necessary fields.
  - Users can validate the strength and format of the provided user password.
  - Users can edit their password.
  - Administrators and users can view a list of existing users in the organization.
  - Administrators and users can invite new users to be added by email.
  - Administrators can delete existing users.
  - Administrators can perform organization approvals for new users.
- Out-of-Scope:
  - Users can delete existing users.
  - Users can perform organization approvals for new users.
  - Administrators and/or users can edit existing user information like first name, last name, email, phone number, etc.

**Design**

- Overview: The overall structure uses the AuthController to allow the user to make a web request to login, register, change password, and confirm a new user.  The AuthController gets called, which in turn accesses the methods in the ApplicationIdentityUserManager, SignInManager, MembershipManager, OrganizationManager, AccessRequestManager, and TermsConditionsManager.  It then uses the PersonRepository, PersonEmailRepository, and OrganizationMemberRepository to retrieve, add, or edit the appropriate data from the Server if the request is valid.  In addition, the structure uses the OrganizationMembersController to view, invite, or delete users from the organization.  The OrganizationMembersController gets called, which in turn accesses the methods in the MembershipManager, UserManager, and AccessRequestsManager.  It then uses the PersonRepository to retrieve, add, or delete the appropriate data from the Server if the request is valid.  Also, the structure uses the AccessRequestsController to view, add, accept, or reject users into an organization.  The AccessRequestsController gets called, which in turn accesses the methods in the MembershipManager, UserManager, and AccessRequestsManager.  It then uses the AccessRequestRepository to retrieve, add, edit, or delete the appropriate data from the Server if the request is valid.  If the request is invalid for any of the above requests, the user will receive an error message stating the error that occured while trying to process the request.
- Proposed Solution:
  - User Interface:
    - When a user enters the main URL, the first page will allow the user to log in.  If a user is not registered in the Server, there will be a link to redirect the user to register.
      - On the Register page, users will enter their name, department (organization will be pending until approved by administrator), email address, password, and confirmed password.
      - After registering, the user will be able to log in once approved from an organization administrator.  Alternatively, a user can be invited through email and will be able to log in using a temporary password.
      - After logging in with an appropriate email address and password, the user will be redirected to the Dashboard.
         - Upon logging in for the first time, users will have to agree to the Terms and Conditions before being redirected to the Dashboard.
    - In the Dashboard under Team, users will be able to click on the "All Team Members" link to view all users within the organization.
      - Administrators will have the option to delete a user.
      - Administrators and users will have the option to invite a new user to register.
        - When a new user gets the invitation email, there will be a randomly generated password to sign in with in the email.  After signing in, all users have the option to change their password by clicking the picture of the person in the top right corner and selecting "Change Password".
          - On the Change Password page, users will be able to enter their old password and new password, and then confirm their new password.
    - In the Dashboard under Team, users will be able to click on the "Pending Approvals" link to view all users who have pending requests to join the organization.
      - Administrators will have the option to accept or reject users into the organization.
- Controllers:
  - AuthController:
    - The AuthController inherits from ApplicationBaseController.  It will make an API request and use the ApplicationIdentityUserManager, SignInManager, MembershipManager, EmailManager, OrganizationManager, AccessRequestsManager, and TermsConditionsManager to access the PersonRepository, PersonEmailRepository, EmailVerificationRepository, AuditLogRepository, and OrganizationMemberRepository to track user logins and add or edit users from the Server and will return that information back to the view.
    - NOTE: The current API version is 1.
    - Routes:
      - Login (create bearer token): [HttpPost("api/v{apiVersion}/auth/token")]
        - Payloads
          - Input : Username, Password
          - Output : 200 OK response with Person information and Token
      - Register: [HttpPost("api/v{apiVersion}/auth/register")]
        - Payloads
          - Input : Signup view model (Name, Department, Email Address, Password)
          - Output : 200 OK response
      - Edit Password: [HttpPut("api/v{apiVersion}/auth/changepassword")]
        - Payloads
          - Input : Old Password, New Password, Confirm Password
          - Output : 200 OK response
      - Verify Token: [HttpGet("api/v{apiVersion}/auth/verifyusertoken")]
        - Payloads
          - Input : User id, code
          - Output : Redirect to appropriate web url
      - Set password: [HttpPut("api/v{apiVersion}/auth/setpassword")]
        - Payloads
          - Input : User id, New password, Token
          - Output : 200 OK response
      - Set user password: [HttpPut("api/v{apiVersion}/auth/setuserpassword")]
        - Payloads
          - Input : New password
          - Output : 200 OK response
      - Confirm new user: [HttpGet("api/v{apiVersion}/auth/confirmemail")]
        - Payloads
          - Input : User id, code
          - Output : Redirect to appropriate web url
      - Forgot Password: [HttpPost("api/v{apiVersion}/auth/forgotpassword")]
        - Payloads
          - Input : Email address, Company
          - Output : 200 OK response
      - Get user information: [HttpGet("api/v{apiVersion}/auth/getuserinfo")]
        - Payloads
          - Input : None
          - Output : JSON file listing authenticated user information
      - Resend email confirmation: [HttpPut("api/v{apiVersion}/auth/resendemailconfirmation")]
        - Payloads
          - Input : Email address
          - Output : 200 OK response
      - Confirm email address: [HttpGet("api/v{apiVersion}/auth/confirmemailaddress")]
        - Payloads
          - Input : Email address, Token
          - Output : Redirect to appropriate web url
      - Refresh token: [HttpPost("api/v{apiVersion}/auth/refresh")]
        - Payloads
          - Input : Token, Refresh Token
          - Output : New Bearer token and refresh token
    - OrganizationMembersController:
      - The OrganizationMembersController inherits from EntityController<OrganizationMember>.  It will make an API request to the MembershipManager, ApplicationIdentityUserManager, and AccessRequestsManager to access the PersonRepository to retrieve, add, or delete users in the organization from the Server and will return that information back to the view.
      - Routes
        - Get people in organization: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/organizationmembers/people")]
          - Payloads
            - Input : Organization id
            - Output : JSON file listing all people in organization information
        - Get organization members: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/organizationmembers")]
          - Payloads
            - Input : Organization id
            - Output : JSON file listing all organization member information
        - Get organization member for specific organization [HttpGet("api/v{apiVersion}/organizations/{organizationId}/organizationmembers/{id}")]
          - Payloads
            - Input : Organization id
            - Output : JSON file listing all corresponding organization member information
        - Add new member: [HttpPost("api/v{apiVersion}/organizations/{organizationId}/organizationmembers")]
          - Payloads
            - Input : Organization id, OrganizationMember model
            - Output : JSON file listing new organization member information
        - Edit organization member: [HttpPut("api/v{apiVersion}/organizations/{organizationId}/organizationmembers/{id}")]
          - Payloads
            - Input : Organization id, Organization member id, OrganizationMember model
            - Output : JSON file listing updated organization member information
        - Invite user as organization member: [HttpPost("api/v{apiVersion}/organizations/{organizationId}/organizationmembers/inviteuser")]
          - Payoads
            - Input : Organization id, Name, Email, Password (optional), Skip email verification (optional)
            - Output : 200 OK response
        - Delete user from organization: [HttpDelete("api/v{apiVersion}/organizations/{organizationId}/organizationmembers/{id}")]
          - Payloads
            - Input : Organization id, Organization member id
            - Output : 200 OK response
        - Edit organization member property: [HttpPatch("api/v{apiVersion}/organizations/{organizationId}/organizationmembers/{id}")]
          - Payloads
            - Input : Organization id, Organization member id, JSONPatchDocument in request body with changes
            - Output : 200 OK response
    - AccessRequestsController:
      - The AccessRequestsController inherits from EntityController<AccessRequest>.  It will make an API request to the MembershipManager, AccessRequestsManager, and ApplicationIdentityUserManager to access the AccessRequestRepository to retrieve, add, accept, or reject requests to join the organization from the Server and will return that information back to the view.
      - Routes
        - All access requests: [HttpGet(api/v{apiVersion}/organizations/{organizationd}/accessrequests)]
          - Payloads
            - Input : Organization id
            - Output : JSON file listing all access requests
        - All pending requests: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/accessrequests/pending")]
          - Payloads
            - Input : Organization id
            - Output : JSON file listing users with pending access to organization
        - Get access request: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/accessrequests/{id}")]
          - Payloads
            - Input : Organization id
            - Output : JSON file listing all access requests for a specific organization
        - Add new request to organization: [HttpPost("api/v{apiVersion}/organizations/{organizationId}/accessrequests")]
          - Payloads
            - Input : Organization id, AccessRequest model
            - Output : JSON file listing new access request information
        - Edit access request: [HttpPut("api/v{apiVersion}/organizations/{organizationId}/accessrequests/{id}")]
          - Payloads
            - Input : Organization id, Access request id, AccessRequest model
            - Output : JSON file listing updated access request information
        - Approve request: [HttpPut("/apt/v{apiVersion}/organizations/{organizationId}/accessrequests/{id}/approve)"]
          - Payloads
            - Input : Organization id, Access request id
            - Output : 200 OK response
        - Reject request: [HttpPut("api/v{apiVersion}/organizations/{organizationId}/accessrequests/{id}/reject)"]
          - Payloads
            - Input : Organization id, Access request id
            - Output : 200 OK response
        - Delete request: [HttpDelete("api/v{apiVersion}/organizations/{organizationId}/accessrequests/{id}")]
          - Payloads
            - Input : Access request id
            - Output : 200 OK response
        - Edit request property: [HttpPatch("api/v{apiVersion}/organizations/{organizationId}/accessrequests/{id}")]
          - Payloads 
            - Input : Access request id, JSONPatchDocument in request body with changes
            - Output : 200 OK response
- Managers:
  - ApplicationIdentityUserManager:
   - The ApplicationIdentityUserManager will inherit UserManager<ApplicationUser>.
      - Beyond the base class, ApplicationIdentityUserManager will implement the appropriate methods to assist AuthController, OrganizationMembersController, and AccessRequestsController.
  - SignInManager:
    - The SignInManager<ApplicationUser> is part of Microsoft.AspNetCore.Identity and assists AuthController.
      - SignInManager provides the API for user sign in.
  - MembershipManager:
    - The MembershipManager will inherit BaseManager, which inherits IManager, and IMembershipManager.
      - Beyond the base class and interfaces, MembershipManager will implement the appropriate methods to assist AuthController, OrganizationMembersController, and AccessRequestsController.
  - OrganizationManager:
    - The OrganizationManager will inherit BaseManager, which inherits IManager, and IOrganizationManager.
      - Beyond the base class and interfaces, OrganizationManager will implement the appropriate methods to assist AuthController.
  - AccessRequestManager:
    - The AccessRequestManager will inherit BaseManager, which inherits IManager, and IAccessRequestManager.
      - Beyond the base class and interfaces, AccessRequestManager will implement the appropriate methods to assist AuthController, OrganizationMembersController, and AccessRequestsController.
  - TermsConditionsManager:
    - The TermsConditionsManager will inherit BaseManager, which inherits IManager, and ITermsConditionsManager.
      - Beyond the base class and interfaces, TermsConditionsManager will implement the appropriate methods to assist AuthController.
  - EmailManager:
    - The EmailManager will inherit BaseManager, which inherits IManager, and IEmailManager.
      - Beyond the base class and interfaces, EmailManager will implement the appropriate methods to assist AuthController and OrganizationMembersController.
- Repositories:
  - PersonRepository:
   - The PersonRepository will inherit TenantEntityRepository<Person>, which inherits EntityRepository<Person> and ReadOnlyEntityRepository<Person>, and IPersonRepository.
     - Beyond the base classes and interface, PersonRepository will access the People data table to retrieve, add, edit, or delete the entity in the Server.
  - PersonEmailRepository:
   - The PersonEmailRepository will inherit EntityRepository<PersonEmail>, which inherits EntityRepository<PersonEmail> and ReadOnlyEntityRepository<PersonEmail>, and IPersonEmailRepository.
     - Beyond the base classes and interface, PersonEmailRepository will access the PersonEmails data table to add, edit, or retrieve the entity in the Server.
  - OrganizationMemberRepository:
   - The OrganizationMemberRepository will inherit TenantEntityRepository<OrganizationMember>, which inherits EntityRepository<OrganizationMember> and ReadOnlyEntityRepository<OrganizationMember>, and IOrganizationMemberRepository.
     - Beyond the base classes and interface, OrganizationMemberRepository will access the OrganizationMembers data table to retrieve, add, edit, or delete the entity in the Server.
  - AccessRequestRepository:
    - The AccessRequestRepository will inherit TenantEntityRepository<AccessRequest>, which inherits EntityRepository<AccessRequest> and ReadOnlyEntityRepository<AccessRequest>, and IAccessRequestRepository.
      - Beyond the base classes and interface, AccessRequestRepository will access the AccessRequests data table to retrive, add, or edit the entity in the Server.
  - EmailVerificationRepository:
    - The EmailVerificationRepository will inherit EntityRepository<EmailVerification>, which inherits ReadOnlyEntityRepository<EmailVerification>, and IEmailVerificationRepository.
      - Beyond the base classes and interface, EmailVerificationRepository will access the EmailVerifications data table to retrieve, add, or edit the entity in the Server.
  - AuditLogRepository:
    - The AuditLogRepository will inherit EntityRepository<AuditLog>, which inherits ReadOnlyEntityRepository<AuditLog>, and IAuditLogRepository.
      - Beyond the base classes and interfaces, AuditLogRepository will access the AuditLogs data table to add audit log entities in the Server when a user or agent logs in.
- Models:
  - LoginModel Data Model:
    - The LoginModel data model will be used to authorize access to certain views.
      - LoginModel will have string Username and string Password.
  - ApplicationUser (AspNetUsers) Data Model:
    - The ApplicationUser data model will be used to view details of each user.  It inherits from IdentityUser, which is part of the ASP.NET Core Identity API.
      - In addition to the properties in the base class, ApplicationUser will have Guid PersonId, bool ForcedPasswordChange, bool IsUserConsentRequired, string Utm_Source, string Utm_Medium, string Utm_Campaign, string Utm_Term, string Utm_Content, string Plan, and string Name.
  - SignupViewModel View Model:
    - The SignupViewModel view model will be used to register a new user in the view.
      - SignUpViewModel will have string Name, string Organization, string Department, string Email, string Password, bool CreateNewOrganization, string Utm_Source, string Utm_Medium, string Utm_Campaign, string Utm_Term, string Utm_Content, string Plan, and Guid ApiKey.
  - Organization Data Model:
    - The Organization data model will be used to determine which organization a user is in and create a new one if a user signs up with an organization that is not currently in the Server.  It inherits the Entity class and ITentanted interface.
      - Organization will have string Name, string Description, bool IsPublic, bool IsVisibletoEmailDomain, string EmailDomain, string PrivateKey, string Salt, int ProcessKeyNumber, string ProcessKeyPrefix, int MyProperty, double AllowedStorageInBytes, double StorageUsedInBytes, bool IsDocumentStorageEnabled, and Guid OrganizationId.
  - EmailVerification Data Model:
    - The EmailVerification data model will be used to verify a user's email.  It inherits the Entity data model.
      - EmailVerification will have Guid PersonId, string Address, bool IsVerified, int VerificationEmailCount, string VerificationCode, DateTime VerificationCodeExpiresOn, bool IsVerificationEmailSent, DateTime VerificationSentOn, and Person Person.
  - Person Data Model:
    - The Person data model will be used to store information about each user.  It inherits the NamedEntity class, which inherits the Entity class, and the ITenanted interface.
      - In addition to the properties inherited from the base classes, Person will have string FirstName, string LastName, bool IsAgent, string Company, and string Department.
  - PersonEmail Data Model:
    - The PersonEmail data model will be used to store user's email addresses.  It inherits the Entity class.
      - In addition to the properties inherited from the base class, PersonEmail will have Guid PersonId, string Address, Guid EmailVerificationId, Person Person, and bool IsPrimaryEmail.
  - RefreshModel View Model:
    - The RefreshModel view model will be used to refresh a token.
      - RefreshModel will have string Token and string RefreshToken.
  - ChangePasswordBindingModel View Model:
    - The ChangePasswordBindingModel view model will be used to change a user's password.
      - ChangePasswordBindingModel will have string OldPassword, string NewPassword, and string ConfirmPassword.
  - ResetPasswordBindingModel View Model:
    - The ResetPasswordBindingModel view model will be used to reset a user's password.
      - ResetPasswordBindingModel will have string UserId, string NewPassword, and string Token.
  - SetPasswordBindingModel View Model:
    - The SetPasswordBindingModel view model will be used to set a user's password.
      - SetPasswordBindingModel will have string NewPassword.
  - ForgotPasswordBindingModel View Model: 
    - The ForgotPasswordBindingModel view model will be used to remind hte user of the stored password used to log in.
      - ForgotPasswordBindingModel will have string Email and string Company.
  - PendingAccessRequest View Model:
    - The PendingAccessRequest view model will be used to display pending access requests.
      - PendingAccessRequest will have Guid Id, string Name, and string Email.
  - AccessRequest Data Model:
    - The AccessRequest data model will be used to store details of a user requesting access into an organization.  It inherits Entity, which inherits IEntity, and ITenanted.
      - Beyond the base class and interfaces, AccessRequest will have Guid OrganizationId, Guid PersonId, bool IsAccessRequested, DateTime AccessRequestedOn, Organization Organization, and Person Person.
  - OrganizationMember Data Model:
    - The OrganizationMember data model will be used to display user information for members of an organization.  It inherits the Entity class, which inherits IEntity, and ITenanted.
      - In addition to the properties inherited from the base class, OrganizationMember will have Guid OrganizationId, Guid PersonId, bool IsAdministrator, string ApprovedBy, DateTime ApprovedOn, bool IsInvited, string InvitedBy, DateTime InvitedOn, bool InviteAccepted, DateTime InviteAcceptedOn, bool IsAutoApprovedByEmailAddress, and Person Person.
  - TeamMember View Model:
    - The TeamMember view model will be used to display the team members in an organization.
      - TeamMember will have Guid PersonId, Guid OrganizationMemberId, string Name, string UserName, string Title, string EmailAddress, string Status, DateTime JoinedOn, string InvitedBy, and bool IsAdmin.
  - InviteUserViewModel View Model:
    - The InviteUserViewModel view model will be used to invite a user into the organization.
      - InviteUserViewModel will have Guid OrganizationId, Guid ProcessId, string Email, string Name, string Company, string Department, and string ShareUrl.

**Sequence Diagrams**

- AuthController:
  - [Login Sequence Diagram](Sequence Diagrams/AuthController/LoginSequenceDiagram.png)
  - [Register Sequence Diagram](Sequence Diagrams/AuthController/RegisterSequenceDiagram.png)
  - [Edit Password Sequence Diagram](Sequence Diagrams/AuthController/EditPasswordSequenceDiagram.png)
  - [Verify Token Sequence Diagram](Sequence Diagrams/AuthController/VerifyTokenSequenceDiagram.png)
  - [Reset Password Sequence Diagram](Sequence Diagrams/AuthController/ResetPasswordSequenceDiagram.png)
  - [Set User Password](Sequence Diagrams/AuthController/SetUserPasswordSequenceDiagram.png)
  - [Confirm New User Sequence Diagram](Sequence Diagrams/AuthController/ConfirmNewUserSequenceDiagram.png)
  - [Forgot Password Sequence Diagram](Sequence Diagrams/AuthController/ForgotPasswordSequenceDiagram.png)
  - [Get User Information Sequence Diagram](Sequence Diagrams/AuthController/GetUserInformationSequenceDiagram.png)
  - [Resend Email Confirmation](Sequence Diagrams/AuthController/ResendEmailConfirmationSequenceDiagram.png)
  - [Confirm Email Address](Sequence Diagrams/AuthController/ConfirmEmailSequenceDiagram.png)
  - [Refresh Token](Sequence Diagrams/AuthController/RefreshTokenSequenceDiagram.png)
- OrganizationMembersController:
  - [People in Organization Sequence Diagram](Sequence Diagrams/OrganizationMembersController/PeopleinOrganizationSequenceDiagram.png)
  - [Organization Members Sequence Diagram](Sequence Diagrams/OrganizationMembersController/OrganizationMembersSequenceDiagram.png)
  - [Organization Member Details Sequence Diagram](Sequence Diagrams/OrganizationMembersController/OrganizationMemberDetailsSequenceDiagram.png)
  - [Create Organization Member Sequence Diagram](Sequence Diagrams/OrganizationMembersController/CreateOrganizationMemberSequenceDiagram.png)
  - [Edit Organziation Member Sequence Diagram](Sequence Diagrams/OrganizationMembersController/EditOrganizationMemberSequenceDiagram.png)
  - [Delete User From Organization Sequence Diagram](Sequence Diagrams/OrganizationMembersController/DeleteOrganizationMemberSequenceDiagram.png)
  - [Invite Organization Member Sequence Diagram](Sequence Diagrams/OrganizationMembersController/InviteOrganizationMemberPropertySequenceDiagram.png)
  - [Edit Organization Member Property Sequence Diagram](Sequence Diagrams/OrganizationMembersController/EditOrganizationMemberPropertySequenceDiagram.png)
- AccessRequestsController:
  - [All Access Requests Sequence Diagram](Sequence Diagrams/AccessRequestsController/AllAccessRequestsSequenceDiagram.png)
  - [Pending Requests Sequence Diagram](Sequence Diagrams/AccessRequestsController/PendingAccessRequestsSequenceDiagram.png)
  - [Access Request Details Sequence Diagram](Sequence Diagrams/AccessRequestsController/AccessRequestDetailsSequenceDiagram.png)
  - [Create Access Request Sequence Diagram](Sequence Diagrams/AccessRequestsController/CreateAccessRequestSequenceDiagram.png)
  - [Edit Access Request Sequence Diagram](Sequence Diagrams/AccessRequestsController/EditAccessRequestSequenceDiagram.png)
  - [Approve Access Request Sequence Diagram](Sequence Diagrams/AccessRequestsController/ApproveAccessRequestSequenceDiagram.png)
  - [Reject Access Request Sequence Diagram](Sequence Diagrams/AccessRequestsController/RejectAccessRequestSequenceDiagram.png)
  - [Delete Access Request Sequence Diagram](Sequence Diagrams/AccessRequestsController/DeleteAccessRequestSequenceDiagram.png)
  - [Edit Access Request Property Sequence Diagram](Sequence Diagrams/AccessRequestsController/EditAccessRequestPropertySequenceDiagram.png)

**Unit Tests**

- Positive Test Cases: N/A
- Negative Test Cases: N/A