Author: NC
Creation Date: 8/19/2020

Updated By: NC
Updated On: 6/18/2021

**Queue Component**

**Context**

- Problem: Users are unable to view, create, edit, delete, and utilize queues.  A user should be able to create new queues by defining their name and retry count as well as either edit or delete existing queues from the list.  In addition, a user should be able to utilize the queues to store queue item transactions from automations and update the status of those transactions containing a priority and arbitrary data in text/JSON format.  A user should be able to view the list of queues and some basic statistics about each queue.  In addition, a user should be able to add, edit, delete, or view queue items that have been assigned to each queue and the appropriate details for each queue item.  A user should be able to attach files to queue items when necessary and edit, remove, or export those files.
- Requirements: Ensure that a user is able to create new named queues and view the list of created queues, edit and delete existing queues, create transactions from automations associated with a queue, and view, create, edit, or delete arbitrary text/JSON data as queue item transactions.  Ensure that a user is able to attach files to a queue item and edit, delete, or export an attached file.

**Component Scope**

- In-Scope:
  - User can create new named queues.
  - User can view, edit, or delete existing queues.
  - User can create queue item transactions from automations associated with a queue.
  - User can view, create, edit, or delete arbitrary text/JSON data as queue item transactions.
  - User can attach files to a queue item.
  - User can edit or remove a file attached to a queue item.
  - User can export a file attached to a queue item.
- Out-of-Scope:
  - User can commit, rollback, or extend queue item properties such as State, State Message, IsLocked, LockedOnUTC, LockedBy, LockedUntilUTC, etc.

**Design**

- Overview: The overall structure uses the QueuesController to allow the user to make a web request for the list of queues or to create, edit, or delete a specific queue.  The QueuesController gets called, which in turn utilizes methods in the QueueManager, then uses the QueueRepository to retrieve, add, update, or delete the appropriate data from the Server if the request is valid.  The overall structure of the QueueItemsController allows the user to make a web request to view the queue item transactions or to create, edit, or delete a transaction.  The QueueItemsController gets called, which in turn accesses the QueueItemManager, and then uses the QueueItemRepository to retrieve, create, edit, or delete the appropriate data from the Server if the request is valid.  The overall structure of the QueueItemAttachmentsController allows the user to make a web request to view the queue item attachments or to create, edit, or delete an attachment.  The QueueItemAttachmentsController gets called, which in turn accesses the QueueItemManager, and then uses the QueueItemRepository to retrieve, create, edit, or delete the appropriate data from the Server if the request is valid.  If the request is invalid for any of the above requests, the user will receive an error message stating the error that occured while trying to process the request.
- Proposed Solution:
  - User Interface:
    - In the Dashboard under Queues, there will be links to All Queue Items, Add Queue Item, All Queues, and Add Queue.
    - On the All Queue Items page, the queues will be displayed in a dropdown, which when selected, will show all queue items assigned to it in a table.
      - The headers will be: Name, State, State Message, Locked By, Start Time, Expiration Time, End Time, View, Edit, and Delete.
        - The appropriate data will be displayed underneath each heading for all queue items.
      - There will be a button on the page to allow the user to create a new queue item and add it to the list.
      - There will be a switch where the user can keep a watch for when queue items have been added, altered, or removed.
      - The user can click on each queue item to edit or delete it along with any attached files.
          - The user can also view the queue item details along with any attached files on a separate page.
            - Th user can export or delete queue item attachments.
    - On the All Queues Page, the queues will be shown in a table.
      - The headers will be: Name, Max Retry Count, Created By, Created On, View, Edit, and Delete.
        - The appropriate data will be displayed underneath each heading.
      - There will be a button on the page to allow the user to create a new queue and add it to the list.
      - The user can click on each queue to edit or delete it, or view the queue details on a separate page.
    - On the Add Queue and Add Queue Item pages, the user can input the appropriate details to create a new queue or queue item.
- Controllers:
- NOTE: The current API version is 1.
  - QueuesController:
    - The QueuesController will make an API request to access the QueueRepository to retrieve all queues from the Server and will return that information back to the view.  The controller will utilize this same structure to add, edit, or delete a queue.
    - Routes:
      - All queues: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queues")]
        - Payloads
          - Input : Organization id
          - Output : JSON file listing all queue information
      - Queue count: [HttpGet("api/v{apiVersion}/queues/organizations/{organizationId}/count")]
        - Payloads
          - Input : Organization id
          - Output : Count of queues in the Server
      - Queue details: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queues/{id}")]
        - Payloads
          - Input : Organization id
          - Output : JSON file listing specific queue information
      - Create a queue: [HttpPost("api/v{apiVersion}/organizations/{organizationId}/queues")]
        - Payloads
          - Input : Organization id, Queue model data
          - Output : 200 OK response
      - Update a queue: [HttpPut("api/v{apiVersion}/organizations/{organizationId}/queues/{id}")]
        - Payloads
          - Input : Organization id, queue id, Queue model data
          - Output : 200 OK response
      - Update a queue property: [HttpPatch("api/v{apiVersion}/organizations/{organizationId}/queues/{id}")]
        - Payloads
          - Input : Organization id, JSONPatchDocument in request body with changes
          - Output : 200 Ok response
      - Delete a queue: [HttpDelete("api/v{apiVersion}/organizations/{organizationId}/queues/{id}")]
        - Payloads
          - Input : Organization id, queue id
          - Output : 200 OK response
  - QueueItemsController:
    - The QueueItemsController will make an API request and use the QueueItemManager to execute any business logic involved.  It will then access the QueueItemRepository to retrieve all queue item transactions associated with that particular queue from the Server and will return the information back to the view.  The controller will utilize this same structure to add, edit, delete, or view details of a queue item transaction.
    - Routes:
     - Queue items: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queueitems")]
       - Payloads
         - Input : Organization id
         - Output : JSON file listing queue item information
     - Queue items (view model): [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queueitems/view")]
       - Payloads
         - Input : Organization id
         - Output : JsON file listing queue item view model information
     - Queue item details: [HttpGet("api//organizations/{organizationId}/queueitems/{id}")]
       - Payloads
         - Input : Organization id, queue item id
         - Output : JSON file listing specific queue item information
     - Queue items details (view model): [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queueitems/view/{id}")]
       - Payloads
         - Input : Organization id, queue item id
         - Output : JSON file listing specific queue item view model information
     - Queue item count: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queueitems/count")]
       - Payloads
         - Input : Organization id
         - Output: Count of queue items in the Server
     - Delete a queue item: [HttpDelete("api/v{apiVersion}/organizations/{organizationId}/queueitems/{id}")]
       - Payloads
         - Input : Organization id, queue item id
         - Output : 200 OK response
     - Update queue item property: [HttpPatch("api/v{apiVersion}/organizations/{organizationId}/queueitems/{id}")]
       - Payloads
         - Input : Organization id, JSONPatchDocument in request body with changes
         - Output : 200 OK response
     - Create queue item (enqueue): [HttpPost("api/v{apiVersion}/organizations/{organizationId}/queueitems/enqueue")]
       - Payloads
         - Input : Organization id, QueueItem model data
         - Output : JSON file listing new queue item view model information
     - Pick up next available queue item (dequeue): [HttpPut("api/v{apiVersion}/organizations/{organizationId}/queueitems/dequeue")]
       - Payloads
         - Input: Organization id, agent id, queue id
         - Output: JSON file listing specific queue item view model information
     - Successful queue item (commit): [HttpPut("api/v{apiVersion}/organizations/{organizationId}/queueitems/commit")]
       - Payloads
         - Input : Organization id, lock transaction key
         - Output : JSON file listing updated queue item information
     - Retry/fail queue item (rollback): [HttpPut("api/v{apiVersion}/organizations/{organizationId}/queueitems/rollback")]
       - Payloads
         - Input : Organization id, lock transaction key, error code (nullable), error message (nullable), is fatal (default set to false)
         - Output : JSON file listing updated queue item information
     - Extend queue item: [HttpPut("api/v{apiVersion}/organizations/{organizationId}/queueitems/extend")]
       - Payloads
         - Input : Organization id, lock transaction key
         - Output : JSON file listing updated queue item information
     - Edit state: [HttpPut("api/v{apiVersion}/organizations/{organizationId}/queueitems/{id}/state")]
       - Payloads
         - Input : Organization id, lock transaction key, state (nullable), state message (nullable), error code (nullable), error message (nullable)
         - Output : JSON file listing updated queue item information
     - Edit queue item (with attachments): [HttpPut("api/v{apiVersion}/organizations/{organizationId}/queueitems/{id}")]
       - Payloads
         - Input : Organization id, queue item id, UpdateQueueItemViewModel data (drive name is optional)
         - Output : JSON file listing updated queue item view model information
  - QueueItemAttachmentsController:
    - The QueueItemAttachmentsController will make an API request and use the QueueItemManager to execute any business logic involved.  It will then access the QueueItemAttahmentRepository to retrieve all queue item attachments associated with that particular queue item from the Server and will return the information back to the view.  The controller will utilize this same structure to add, edit, delete, export, or view details of a queue item attachment.
    - Routes:
     - Queue item attachments: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueitemattachments")]
       - Payloads
         - Input : Organization id, queue item id
         - Output : JSON file listing queue item attachment information
     - Queue item attachments (view model): [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueitemattachments/view")]
       - Payloads
         - Input : Organization id, queue item id
         - Output : JSON file listing queue item attachment view information
     - Queue item count: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueitemattachments/count")]
       - Payloads
         - Input : Organization id, queue item id
         - Output : JSON file listing queue item attachment count
     - Queue item attachment details: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueitemattachments/{id}")]
       - Payloads
         - Input : Organization id, queue item id, attachment id
         - Output : JSON file listing specific queue item attachment information
     - Create queue item attachment (existing files): [HttpPost("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueitemattachments/files")]
       - Payloads
         - Input : Organization id, queue item id, attachment id, array of file ids
         - Output : JSON file listing queue item attachment information for a specific queue item
     - Create queue item attachment: [HttpPost("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueitemattachments")]
       - Payloads
         - Input : Organization id, queue item id, attachment id, files to be attached
         - Output : JSON file listing queue item attachment information for a specific queue item
     - Edit queue item attachment with file: [HttpPut("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueitemattachments/{id}/update")]
       - Payloads
         - Input : Organization id, queue item id, attachment id, file to be updated, optional query parameter ("?driveName={driveName}")
         - Output : JSON file listing specific queue item attachment information
     - Edit queue item attachment property: [HttpPatch("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueitemattachments/{id}")]
       - Payloads
         - Input : Organization id, queue item id, attachment id, JSONPatchDocument in request body with changes
         - Output : 200 OK response
     - Delete all queue item attachments for a queue item: [HttpDelete("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueitemattachments")]
       - Payloads
         - Input : Organization id, queue item id, attachment id, optional query parameter ("?driveName={driveName}")
         - Output : 200 OK response
     - Delete queue item attachment: [HttpDelete("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueitemattachments/{id}")]
       - Payloads
         - Input : Organization id, queue item id, attachment id, optional query parameter ("?driveName={driveName}")
         - Output : 200 OK response
    - Export queue item attachment: [HttpGet("api/v{apiVersion}/organizations/{organizationId}/queueitems/{queueItemId}/queueItemAttachments/{id}/export")]
      - Payloads
        - Input : Organization id, queue item id, attachment id
        - Output : Queue item attachment file
- Managers:
  - QueueManager:
    - The QueueManager will inherit BaseManager, which inherits IManager, and IQueueItemManager.
      - Beyond the base class and interfaces, QueueManager will implement the appropriate methods to assist QueuesController.
  - QueueItemManager:
    - The QueueItemManager will inherit BaseManager, which inherits IManager, and IQueueItemManager.
      - Beyond the base class and interfaces, QueueItemManager will implement the appropriate methods to assist QueueItemsController and QueueItemAttachmentsController.
- Repositories:
  - QueueRepository:
    - The QueueRepository inherits from TenantEntityRepository<Queue>, which inherits from ReadOnlyEntityRepository<Queue>, and IQueueRepository.
      - Beyond the base classes and interface, QueueRepository will retrieve all queues, add a new queue, or retrieve/edit/delete a queue by id.
  - QueueItemRepository:
    - The QueueItemRepository inherits from TenantEntityRepository<QueueItemModel>, which inherits from ReadOnlyEntityRepository<QueueItemModel>, and IQueueItemRepository.
      - Beyond the base classes and interface, QueueItemRepository will retrieve all queue items, add a new queue item, or edit/delete a queue item by id.  It will have FindAllView method to allow the view model to display both the properties of the queue item and the corresponding file ids.
  - QueueItemAttachmentRepository:
    - The QueueItemAttachmentRepository inherits from TenantEntityRepository<QueueItemAttachment> and IQueueItemAttachmentRepository.
      - Beyond the base class and interface, QueueItemAttachmentRepository will retrieve all queue item attachments, add a new queue item attachment, or edit/export/delete a queue item attachment by id.
- Models:
  - Queue Data Model:
    - The Queue data model will be used to view details of each queue.  It will inherit the NamedEntity class, which inherits the Entity class, and ITenanted.
      - Beyond the base classes, Queue will have string Description, int MaxRetryCount, and Guid OrganizationId.
  - QueueItemModel Data Model:
    - The QueueItemModel data model will be used to view details of each queue item.  It will inherit the NamedEntity class, which inherits the Entity class, and ITenanted.
      - Beyond the base classes, QueueItemModel will have bool IsLocked, DateTime LockedOnUTC, DateTime LockedUntilUTC, Guid LockedBy, Guid QueueId, string Type, string JsonType, string DataJson, string State, string StateMessage, Guid LockTransactionKey, DateTime LockedEndTimeUTC, int RetryCount, int Priority, DateTime ExpireOnUTC, DateTime PostponeUntilUTC, string ErrorCode, string ErrorMessage, string ErrorSerialized, string Source, string Event, string ResultJSON, long PayloadSizeInBytes, Guid OrganizationId, Guid IntegrationEventId, and Guid EventLogId.
  - QueueItemAttachment Data Model:
    - The QueueItemAttachment data model will be used to view the file ids that correlate with the attachments of a queue item.  It will inherit the Entity class.
      - Beyond the base class, QueueItemAttachment will have Guid QueueItemId, Guid FileId, long SizeInBytes, and Guid OrganizationId.
  - Queue View Model:
    - The QueueViewModel view model will be used to view details of each queue.
      - QueueViewModel will have string Name (required), string Description, and int MaxRetryCount.
  - AllQueueItemsViewModel View Model:
    - The AllQueueItemsVieWModel view model will be used to view details of each queue item in addition to the list of related file ids (file attachments).  It will inherit IViewModel<QueueItemmodel, AllQueueItemsViewModel>.
      - Beyond the interface, AllQueueItemsViewModel will have string Name, Guid Id, string State, string StateMessage, bool IsLocked, Guid LockedBy, DateTime LockedOnUTC, DateTime LockedUntilUTC, DateTime LockedEndTimeUTC, DateTime ExpireOnUTC, DateTime PostponeUntilUTC, string ErrorCode, string ErrorMessage, string ErrorSerialized, string Source, string Event, string ResultJSON, List<Guid> FileIds, Guid QueueId, DateTime CreatedOn, and long PayloadSizeInBytes.
  - QueueItemViewModel View Model:
    - The QueueItemViewModel view model will be used to view details of an individual queue item in addition to the list of related file ids (file attachments).  It will inherit NamedEntity, which inherits Entity, and IViewModel<QueueItemModel, QueueItemViewModel>.
      - Beyond the base classes and interface, QueueItemViewModel will have string State, string StateMessage, bool IsLocked, Guid LockedBy, DateTime LockedOnUTC, DateTime LockedUntilUTC, DateTime LockedEndTimeUTC, DateTime ExpireOnUTC, DateTime PostponeUntilUTC, string ErrorCode, string ErrorMessage, string ErrorSerialized, string Source, string Event, string ResultJSON, Guid QueueId, string Type, string JsonType, string DataJson, Guid LockTransactionKey, int RetryCount, int Priority, long PayloadSizeInBytes, and List<QueueItemAttachment> Attachments.
  - UpdateQueueItemViewModel View Model:
    - The UpdateQueueItemViewModel view model will be used to update details of an individual queue item in addition to the list of related file ids (file attachments).  It will inherit IViewModel<QueueItemModel, UpdateQueueItemModel>.
      - Beyond the interface, UpdateQueueItemViewModel will have Guid Id, string Name, Guid QueueId, string Source, string Event, DateTime ExpireOnUTC, DateTime PostponeUntilUTC, string Type, string DataJson, string State, List<Guid> FileIds, IFormFile[] Files, and string DriveId.
  - AllQueueItemAttachments View Model:
    - The AllQueueItemAttachmentsViewModel view model will be used to view details of queue item attachments associated with a particular queue item.
      - AllQueueItemAttachmentsViewModel will have Guid QueueItemId, Guid FileId, long SizeInBytes, and string Name.

**Sequence Diagrams**

Queue
- [Queue Component Sequence Diagram](Sequence Diagrams/QueuesController/QueueComponentSequenceDiagram.png)
- [Queue Count Sequence Diagram](Sequence Diagrams/QueuesController/QueueCountSequenceDiagram.png)
- [Create Queue Sequence Diagram](Sequence Diagrams/QueuesController/CreateQueueSequenceDiagram.png)
- [Edit Queue Sequence Diagram](Sequence Diagrams/QueuesController/CreateQueueSequenceDiagram.png)
- [Edit Queue Property Sequence Diagram](Sequence Diagrams/QueuesController/EditQueueSequenceDiagram.png)
- [Queue Details Sequence Diagram](Sequence Diagrams/QueuesController/EditQueuePropertySequenceDiagram.png)
- [View Queue Sequence Diagram](Sequence Diagrams/QueuesController/QueueDetailsSequenceDiagram.png)
- [Delete Queue Sequence Diagram](Sequence Diagrams/QueuesController/DeleteQueueSequenceDiagram.png)
Queue Item
- [Queue Item Component Sequence Diagram](Sequence Diagrams/QueueItemsController/QueueItemComponentSequenceDiagram.png)
- [Queue Item Count Sequence Diagram](Sequence Diagrams/QueueItemsController/QueueItemCountSequenceDiagram.png)
- [Queue Item Details Sequence Diagram](Sequence Diagrams/QueueItemsController/QueueItemDetailsSequenceDiagram.png)
- [Enqueue Queue Item Sequence Diagram](Sequence Diagrams/QueueItemsController/CreateQueueItemSequenceDiagram.png)
- [Edit Queue Item Sequence Diagram (Dequeue, Commit, Extend, State, Edit with Attachments)](Sequence Diagrams/QueueItemsController/EditQueueItemSequenceDiagram.png)
- [Edit Queue Item Property Sequence Diagram](Sequence Diagrams/QueueItemsController/EditQueueItemPropertySequenceDiagram.png)
- [Delete Queue Item Sequence Diagram](Sequence Diagrams/QueueItemsController/DeleteQueueItemSequenceDiagram.png)
- [Rollback Queue Item Sequence Diagram](Sequence Diagrams/QueueItemsController/RollbackQueueItemSequenceDiagram.png)

Queue Item Attachments
- [Queue Item Attachment Component Sequence Diagram](Sequence Diagrams/QueueItemAttachmentsController/QueueItemAttachmentComponentSequenceDiagram.png)
- [Queue Item Attachment Count Sequence Diagram](Sequence Diagrams/QueueItemAttachmentsController/QueueItemAttachmentCountSequenceDiagram.png)
- [Queue Item Attachment Details Sequence Diagram](Sequence Diagrams/QueueItemAttachmentsController/QueueItemAttachmentDetailsSequenceDiagram.png)
- [Create Queue Item Attachment Sequence Diagram](Sequence Diagrams/QueueItemAttachmentsController/CreateQueueItemAttachmentSequenceDiagram.png)
- [Edit Queue Item Attachment Sequence Diagram](Sequence Diagrams/QueueItemAttachmentsController/EditQueueItemAttachmentSequenceDiagram.png)
- [Edit Queue Item Attachment Property Sequence Diagram](Sequence Diagrams/QueueItemAttachmentsController/EditQueueItemAttachmentPropertySequenceDiagram.png)
- [Delete Queue Item Attachment(s) Sequence Diagram](Sequence Diagrams/QueueItemAttachmentsController/DeleteQueueItemAttachmentSequenceDiagram.png)
- [Export Queue Item Attachment Sequence Diagram](Sequence Diagrams/QueueItemAttachmentsController/ExportQueueItemAttachmentSequenceDiagram.png)

**Unit Tests**

- Positive Test Cases: N/A
- Negative Test Cases: N/A