Author: NC
Creation Date: 12/4/2020

Updated By: NC
Updated On: 6/15/2021

**Email Component**

**Context**

- Problem: Users cannot view and modify email configuration settings or send emails.  Administrators should be able to create an email message, attach files to the email, and send the email message.  Administrators should be able to view and modify core system email settings and accounts.
- Requirements: Ensure that an administrator is able to modify key system email settings and accounts.  Ensure that an administrator is able to create an email message, attach files, and send email messages.
- NOTE: If you are using a Google email account and your messages are not sending, please follow the steps below: (from https://serverfault.com/questions/635139/how-to-fix-send-mail-authorization-failed-534-5-7-14)
  - It may take more than one step to fix this issue
    1. Log into your Google account and then go to this link: https://www.google.com/settings/security/lesssecureapps.  Set "Access For Less Secure Apps" to ON. Test to see if your issue is resolved. If it isn't resolved, continue to Step #2.	
    2. Go to https://support.google.com/accounts/answer/6009563 (Titled: "Password incorrect error"). This page says "There are several reasons why you might see a 'Password Incorrect' error (aka 534-5.7.14) when signing in to Google using third-party apps. In some cases, even if you type your password correctly." This page gives four suggestions of things to try.
      - In most cases, the first suggestion works: Go to https://g.co/allowaccess from a different device you have previously used to access your Google account and follow the instructions.
	    - Try signing in again from the blocked app and send an email.

**Component Scope**

- In-Scope:
  - Administrator can view configuration settings for email accounts and settings.
  - Administrator can edit or delete configuration settings for email accounts.
  - Administrator can add email accounts.
  - Administrator can view system configuration setting details for each item in the provided list.
  - Administrator can edit configuration settings for email settings.
  - Administrator can view emails for all email attempts made in the organization.
  - Administrator can view email details.
  - Administrator can add, edit, or delete an email.
  - Administrator can create and send an email message.
  - Administrator can attach files to an email message.
- Out-of-Scope:
  - Administrator and/or user can add a new configuration setting to the list of email settings.

**Design**

- Overview: The overall structure uses the EmailAccountsController, EmailSettingsController, EmailsController, and EmailAttachmentsController to allow the user to make a web request.  A Controller gets called and then uses the EmailAccountRepository, EmailSettingsRepository, EmailRepository, or EmailAttachmentRepository to retrieve, add, edit, attach a file, or delete the appropriate data from the Server if the request is valid.  If the request is invalid, the user will receive an error message stating the error that occurred while trying to process the request.
- Proposed Solution:
  - User Interface:
    - In the Dashboard, there will be links to redirect users under the "Emails" heading.
      - In the dropdown, the user will be able to select and save the configuration values for each of the following configuration sections: Email Settings, Email Accounts.
      - The user can change the Email Settings by clicking the "Settings" link and entering the values for each setting.  The user can enable or disable emails on this page as well.
        - There will be an "Enable" button to ensure changes made are saved.
      - The user can view, add, edit, or delete the Email Accounts by clicking on the "All Email Accounts" link or "Add Email Account" link.
        - The user can view more details of each email account by clicking the link under the "View" heading.
      - The user will be able to create an email, attach files, and send an email by clicking on the "Send Email" link.
      - The user will be able to view all email attempts by clicking on the "Emails" link.
        - The existing email attempts will be displayed in a table.
          - The headers will be: Id, Sender User Id, Sent On Utc, and View.
          - The appropriate data will be displayed underneath each heading.
            - There will be a button to redirect the user to send a new email.
            - The user can click on each email, where the user will be redirected to a view of that specific email's details based on its id.
            - The user can edit a draft email, where files can be uploaded to overwrite the old ones.
            - The user can delete draft emails.
- Controllers:
  - NOTE: The current API version is 1.
  - Email Accounts Controller:
    - The EmailAccountsController will make an API request to access the EmailAccountsRepository in order to retrieve, add, edit, or delete the appropriate email account.
    - Routes:
      - All email accounts: [HttpGet("api/v{apiVersion}/emailaccounts")]
        - Payloads
          - Input : None
          - Output : JSON file listing all existing email account information
      - Email account count: [HttpGet("api/v{apiVersion}/emailaccounts/count")]
        - Payloads
          - Input : None
          - Output : Count of all email accounts
      - Email account details: [HttpGet("api/v{apiVersion}/emailaccounts/{id}")]
        - Payloads
          - Input : Email account id
          - Output : JSON file listing specific email account information
      - Add email account: [HttpPost("api/v{apiVersion}/emailaccounts")]
        - Payloads
          - Input : Email account data model
          - Output : JSON file listing newly created email account information
      - Edit email account: [HttpPut("api/v{apiVersion}/emailaccount/{id}")]
        - Payloads
          - Input : Email account id, Email account data model
          - Output : JSON file listing updated email account information
      - Edit email account property: [HttpPatch("api/v{apiVersion}/emailaccounts/{id}")]
        - Payloads
          - Input : Email account id, JSONPatchDocument in request body with changes
          - Output : 200 OK response
      - Delete email account: [HttpDelete("api/v{apiVersion}/emailaccounts/{id}")]
        - Payloads
          - Input : Email account id
          - Output : 200 OK response
      - Email account lookup: [HttpGet("api/v{apiVersion}/emailaccounts/lookup")]
        - Payloads
          - Input : None
          - Output : JSON file listing all email account ids and names
  - Email Settings Controller:
    - The EmailSettingsController will make an API request to access the EmailSettingsRepository in order to retrieve, add, edit, or delete the appropriate email settings.
    - Routes:
      - All email settings (will only have one by default): [HttpGet("api/v{apiVersion}/emailsettings")]
        - Payloads
          - Input : None
          - Output : JSON file listing email settings information
      - Email settings count: [HttpGet("api/v{apiVersion}/emailsettings/count")]
        - Payloads
          - Input : None
          - Output : Count of all email settings entities (should only return one)
      - Email settings details: [HttpGet("api/v{apiVersion}/emailsettings/{id}")]
        - Payloads
          - Input : Email settings id
          - Output : JSON file listing specific email settings information
      - Add email settings (if one doesn't already exist): [HttpPost("api/v{apiVersion}/emailsettings")]
        - Payloads
          - Input : Email settings data model
          - Output : JSON file listing newly created email settings
      - Edit email settings: [HttpPut("api/v{apiVersion}/emailsettings/{id}")]
        - Payloads
          - Input : Email settings id, Email settings data model
          - Output : JSON file listing updated email settings information
      - Edit email settings property: [HttpPatch("api/v{apiVersion}/emailsettings/{id}")]
        - Payloads
          - Input : Email settings id, JSONPatchDocument in request body
          - Output : 200 OK response
      - Delete email settings: [HttpDelete("api/v{apiVersion}/emailsettings/{id}")]
        - Payloads
          - Input : Email settings id
          - Output : 200 OK response
  - Emails Controller:
    - The EmailsController will make an API request to access the EmailRepository in order to retrieve, add, edit, or delete the appropriate emails.
    - Routes:
      - All emails (view model): [HttpGet("api/v{apiVersion}/emails")]
        - Payloads
          - Input : None
          - Output : JSON file listing all email view model information
      - Email count: [HttpGet("api/v{apiVersion}/emails/count")]
        - Payloads
          - Input : None
          - Output : Count of all emails
      - Email details: [HttpGet("api/v{apiVersion}/emails/{id}")]
        - Payloads
          - Input : Email id
          - Output : JSON file listing specific email information
      - Email details (view model): [HttpGet("api/v{apiVersion}/email/{id}/view")]
        - Payloads
          - Input : Email id
          - Output : JSON file listing specific email view model information
      - Add email (draft): [HttpPost("api/v{apiVersion}/emails")]
        - Payloads
          - Input : Add email view model (direction, all other properties are optional)
          - Output : JSON file listing newly created email draft information
      - Send email draft (update and send existing email): [HttpPut("api/v{apiVersion}/emails/{id}/send")]
        - Payloads
          - Input : Email id, SendEmailViewModel data (anything missing from draft that needs to be included) Email account name (as optional query parameter)
          - Output : JSON file listing updated email view model information
      - Send new email: [HttpPost("api/v{apiVersion}/emails/send")]
        - Payloads
          - Input : SendEmailViewModel data (drive name is optional), Email account name (as optional query parameter)
          - Output : JSON file listing newly created email view model information
      - Edit email: [HttpPut("api/v{apiVersion}/emails/{id}")]
        - Payloads
          - Input : Email id, Email data model
          - Output : JSON file listing updated email information
      - Edit email with file(s): [HttpPut("api/v{apiVersion}/emails/{id}/update")]
        - Payloads
          - Input : Email id, UpdateEmailViewModel data (drive name is optional)
          - Output : JSON file listing updated email view model information
      - Edit email property: [HttpPatch("api/v{apiVersion}/emails/{id}")]
        - Payloads
          - Input : Email id, JSONPatchDocument in request body
          - Output : 200 OK response
      - Delete email: [HttpDelete("api/v{apiVersion}/emails/{id}")]
        - Payloads
          - Input : Email id, drive name (optional)
          - Output : 200 OK response
  - Email Attachments Controller:
    - The EmailAttachmentsController will make an API request to access the EmailAttachmentRepository in order to retrieve, add, edit, or delete the appropriate email attachments.
    - Routes:
      - All email attachments: [HttpGet("api/v{apiVersion}/emails/{emailId}/emailattachments")]
        - Payloads
          - Input : Email id
          - Output : JSON file listing all email attachment information
      - All email attachments view: [HttpGet("api/v{apiVersion}/emails/{emailId}/emailattachments")]
        - Payloads
          - Input : Email id
          - Output : JSON file listing all email attachment view information
      - Email attachment count: [HttpGet("api/v{apiVersion}/emails/{emailId}/emailattachments/count")]
        - Payloads
          - Input : Email id
          - Output : Count of all email attachments
      - Email attachment details: [HttpGet("api/v{apiVersion}/emails/{emailId}/emailattachments/{id}")]
        - Payloads
          - Input : Email id, attachment id
          - Output : JSON file listing specific email attachment  information
      - Add email attachment(s) (using existing Server files): [HttpPost("api/v{apiVersion}/emails/{emailId}/emailattachments/{id}")]
        - Payloads
          - Input : Email id, attachment id, file id(s) list, optional query parameter ("?driveName={driveName}")
          - Output : JSON file listing newly created email attachment(s) information
      - Add email attachment(s) (upload new file(s)): [HttpPost("api/v{apiVersion}/emails/{emailId}/emailattachments")]
        - Payloads
          - Input : Email id, file(s), optional query parameter ("?driveName={driveName}")
          - Output : JSON file listing newly created email attachment(s)
      - Edit email attachment: [HttpPut("api/v{apiVersion}/emails/{emailId}/emailattachments/{id}")]
        - Payloads
          - Input : Email id, attachment id, attachment data model
          - Output : 200 Ok response
      - Edit email attachment (with file): [HttpPut("api/v{apiVersion}/emails/{emailId}/emailattachments/{id}/update")]
        - Payloads
          - Input : Email id, attachment id, UpdateEmailAttachmentViewModel view model (drive name is optional)
          - Output : JSON file listing updated email attachment information
      - Edit email attachment property: [HttpPatch("api/v{apiVersion}/emails/{emailId}/emailattachments/{id}")]
        - Payloads
          - Input : Email id, attachment id, JSONPatchDocument in request body
          - Output : 200 Ok response
      - Delete all email attachments: [HttpDelete("api/v{apiVersion}/emails/{emailId}/emailattachments")]
        - Payloads
          - Input : Email id, optional query parameter ("?driveName={driveName}")
          - Output : 200 Ok response
      - Delete email attachment: [HttpDelete("api/v{apiVersion}/emails/{emailId}/emailattachments/{id}")]
        - Payloads
          - Input : Email id, attachment id, optional query parameter ("?driveName={driveName}")
          - Output : 200 Ok response
      - Export email attachment: [HttpGet("api/v{apiVersion}/emails/{emailId}/emailattachments/{id}/export")]
        - Payloads
          - Input : Email id, attachment id, optional query parameter ("?driveName={driveName}")
          - Output : Email attachment file
- Manager:
  - Email Manager:
    - The EmailManager will inherit BaseManager, which inherits IManager, and IEmailManager.
      - Beyond the base class and interfaces, EmailManager will implement the appropriate methods to assist EmailsController. 
- Repositories:
  - EmailAccountRepository:
    - The EmailAccountRepository will inherit EntityRepository<EmailAccount>, which inherits ReadOnlyEntityRepository<EmailAccount>, and IEmailAccountRepository.
      - Beyond the base classes and interface, EmailAccountRepository will access the EmailAccounts data table to retrieve, add, edit, or delete the entity in the Server.
  - EmailAttachmentRepository:
    - The EmailAttachment Repository will inherit EntityRepository<EmailAttachment>, which inherits ReadOnlyEntityRepository<EmailAttachment>, and IEmailAttachmentRepository.
      - Beyond the base classes and interface, EmailAttachmentRepository will access the EmailAttachments data table to retrieve, add, edit, or delete the entity in the Server.
  - EmailSettingsRepository:
    - The EmailSettingsRepository will inherit EntityRepository<EmailSettings>, which inherits ReadOnlyEntityRepository<EmailSettings>, and IEmailSettingsRepository.
      - Beyond the base classes and interface, EmailSettingsRepository will access the EmailSettings data table to retrieve, add, edit, or delete the entity in the Server.
  - EmailRepository:
    - The EmailRepository will inherit EntityRepository<EmailModel>, which inherits ReadOnlyEntityRepository<EmailModel>, and IEmailRepository.
      - Beyond the base classes and interface, EmailRepository will access the EmailLog data table to retrieve, add, edit, or delete the entity in the Server.
- Models:
  - Email Address Data Model:
    - The EmailAddress data model will be used for email addresses when sending an email.  It has the methods ToMailAddress and IterateBack to assist in the creation of the email message.
      - EmailAddress will have string Name and string Address.
  - Email Attachment Data Model:
    - The EmailAttachment Data Model will be used for storing email attachments when sending an email.  It inherits the NamedEntity class, which inherits Entity and INamedEntity.  Entity inherits the IEntity interface.
      - Beyond the base classes and interfaces, EmailAttachment will have string ContentType, long SizeInBytes, string StorageContentAddress, Guid FileId, and Guid EmailId.
  - Email Account Data Model:
    - The EmailAccount data model will be used to determine which email account to use as the sender of an email.  It inherits the NamedEntity class, which inherits Entity and INamedEntity.  Entity inherits the IEntity interface.
      - Beyond the base classes and interfaces, EmailAccount will have bool IsDisabled, bool IsDefault, string Provider, bool IsSslEnabled, string Host, int Port, string Username, string EncryptedPassword, string PasswordHash, string ApiKey, string FromEmailAddress, string FromName, DateTime StartOnUTC, and DateTime EndOnUTC.
  - Email Settings Data Model:
    - The EmailSettings data model will be used to determine the organization's settings when sending an email.  It inherits the Entity class, which inherits the IEntity interface.
      - Beyond the base class and interface, EmailSettings will have Guid OrganizationId, bool IsEmailDisabled, string AddToAddress, string AddCCAddress, string AddBCCAddress, string AllowedDomains, string BlockedDomains, string SubjectAddPrefix, string SubjectAddSuffix, string BodyAddPrefix, and string BodyAddSuffix.
  - Email Data Model:
    - The EmailModel data model will be used to show the details for all emails in an organization that were a draft, sent, failed, or blocked.  It inherits the Entity class, which inherits the IEntity interface.
      - Beyond the base class and interface, EmailModel will have Guid EmailAccountId, DateTime SentOnUTC, string EmailObjectJson, string SenderName, string SenderAddress, Guid SenderUserId, string Status, string Reason, string Direction, Guid ConversationId, and Guid ReplyToEmailId.
  - Email Message Data Model:
    - The EmailMessage data model will be used to store all details of the email message that is to be sent.
      - EmailMessage will have string MessageID, string InReplyToMessageID, string MessageTopic, DateTime ReceivedOnUTC, List<EmailAddress> From, List<EmailAddress> To, List<EmailAddress> CC, List<EmailAddress> Bcc, EmailAddress Sender, List<EmailAddress> ReplyToList, string Source, bool IsPossibleSpam, bool IsPossibleVirus, int Priority, string Subject, string PlainTextBody, string Body, bool IsBodyHtml, string IsBodyContentStored, string BodyContentStorageAddress, List<EmailHeader> Headers, int DeliveryNotificationOptions, and List<EmailAttachment> Attachments.
  - Add Email View Model:
    - The AddEmailViewModel view model will be used to send information from the API request to the database.  It will inherit IViewModel<EmailViewModel, AddEmailViewModel>.
      - AddEmailViewModel will have Guid EmailAccountId, DateTime SentOnUTC, string EmailObjectJson, string SenderAddress, Guid SenderUserId, string Status, string Direction, and IFormFile[] Files.
  - Email Account View Model:
    - The EmailAccountViewModel view model will be used to display specific properties of an email account.  It will inherit IViewModel<EmailAccount, EmailAccountViewModel>.
      - EmailAccountViewModel will have Guid Id, string Name, bool IsDisabled, bool IsDefault, string Provider, bool IsSslEnabled, string Host, int Port, string Username, string PasswordHash, string ApiKey, string FromEmailAddress, string FromName, DateTime StartOnUTC, and DateTime EndOnUTC.
  - Email Account Lookup:
    - The EmailAccountLookup view model will be used to display a list of email accounts by name.
      - It will have Guid EmailAccountId and string EmailAccountName.
  - Email View Model:
    - The EmailViewModel view model will be used to display specific properties of an email.  It will inherit IViewModel<EmailModel, EmailViewModel>.
      - EmailViewModel will have Guid Id, Guid EmailAccountId, DateTime SentOnUTC, string EmailObjectJson, string SenderAddress, Guid SenderUserId, string Status, and DateTime CreatedOn.
  - Get Emails View Model:
    - The GetEmailsViewModel view model will be used to get all emails from the database.  It will inherit IViewModel<EmailModel, GetEmailsViewModel>.
      - GetEmailsViewModel will have Guid Id, Guid EmailAccountId, DateTime SentOnUTC, string EmailObjectJson, string SenderAddress, string SenderUserId, string Status, and DateTime CreatedOn.
  - Send Email View Model:
    - The SendEmailViewModel view model will be used to send a new email message with attachments.
      - SendEmailViewModel will have string EmailMessageJson and IFormFile[] Files.
  - Update Email View Model:
    - The UpdateEmailViewModel will be used to update a draft email with file attachments.  It will inherit <EmailModel, UpdateEmailViewModel>.
      - UpdateEmailViewModel will have DateTime SentOnUTC, string EmailObjectJson, string SenderName, string SenderAddress, Guid SenderUserId, string Status, string Reason, string Direction, Guid ConversationId, Guid ReplyToEmailId, Guid EmailAccountId, and IFormFile[] Files.
  - All Email Attachments View Model:
    - The AllEmailAttachmentsViewModel view model will be used to display specific properties of email attachments.
      - AllEmailAttachments will have Guid EmailId, Guid FileId, long SizeInBytes, and string Name.
  - Update Email Attachment View Model:
    - The UpdateEmailAttachmentViewModel view model will be used to update an email attachment.
      - UpdateEmailAttachmentViewModel will have Guid Id, string Name, string ContentType, long SizeInBytes, Guid FileId, and IFormFile File.

**Sequence Diagrams**

- EmailAccountsController:
  - [All Email Accounts Sequence Diagram](Sequence Diagrams/EmailAccountsController/AllEmailAccountsSequenceDiagram.png)
  - [Email Accounts Count Sequence Diagram](Sequence Diagrams/EmailAccountsController/EmailAccountCountSequenceDiagram.png)
  - [Email Account Details Sequence Diagram](Sequence Diagrams/EmailAccountsController/EmailAccountDetailsSequenceDiagram.png)
  - [Add Email Account Sequence Diagram](Sequence Diagrams/EmailAccountsController/AddEmailAccountSequenceDiagram.png)
  - [Edit Email Account Sequence Diagram](Sequence Diagrams/EmailAccountsController/EditEmailAccountSequenceDiagram.png)
  - [Edit Email Account Property Sequence Diagram](Sequence Diagrams/EmailAccountsController/EditEmailAccountPropertySequenceDiagram.png)
  - [Delete Email Account Sequence Diagram](Sequence Diagrams/EmailAccountsController/DeleteEmailAccountSequenceDiagram.png)
  - [Email Account Lookup Sequence Diagram](Sequence Diagrams/EmailAccountsController/EmailAccountLookupSequenceDiagram.png)
- EmailSettingsController:
  - [All Email Settings Sequence Diagram](Sequence Diagrams/EmailSettingsController/AllEmailSettingsSequenceDiagram.png)
  - [Email Settings Count Sequence Diagram](Sequence Diagrams/EmailSettingsController/EmailSettingsCountSequenceDiagram.png)
  - [Email Settings Details Sequence Diagram](Sequence Diagrams/EmailSettingsController/EmailSettingsDetailsSequenceDiagram.png)
  - [Add Email Settings Sequence Diagram](Sequence Diagrams/EmailSettingsController/AllEmailSettingsSequenceDiagram.png)
  - [Edit Email Settings Sequence Diagram](Sequence Diagrams/EmailSettingsController/EditEmailSettingsSequenceDiagram.png)
  - [Edit Email Settings Property Sequence Diagram](Sequence Diagrams/EmailSettingsController/EditEmailSettingsPropertySequenceDiagram.png)
  - [Delete Email Settings Sequence Diagram](Sequence Diagrams/EmailSettingsController/DeleteEmailSettingsSequenceDiagram.png)
- EmailsController:
  - [All Emails Sequence Diagram](Sequence Diagrams/EmailsController/AllEmailsSequenceDiagram.png)
  - [Emails Count Sequence Diagram](Sequence Diagrams/EmailsController/EmailCountSequenceDiagram.png)
  - [Email Details Sequence Diagram](Sequence Diagrams/EmailsController/EmailDetailsSequenceDiagram.png)
  - [Add Email Sequence Diagram](Sequence Diagrams/EmailsController/AddEmailSequenceDiagram.png)
  - [Send New Email Sequence Diagram](Sequence Diagrams/EmailsController/SendNewEmailSequenceDiagram.png)
  - [Send Email Draft Sequence Diagram](Sequence Diagrams/EmailsController/SendEmailDraftSequenceDiagram.png)
  - [Edit Email Sequence Diagram](Sequence Diagrams/EmailsController/EditEmailSequenceDiagram.png)
  - [Edit Email Property Sequence Diagram](Sequence Diagrams/EmailsController/EditEmailPropertySequenceDiagram.png)
  - [Delete Email Sequence Diagram](Sequence Diagrams/EmailsController/DeleteEmailSequenceDiagram.png)
- EmailAttachmentsController:
  - [All Email Attachments Sequence Diagram](Sequence Diagrams/EmailAttachmentsController/AllEmailAttachmentsSequenceDiagram.png)
  - [Email Attachments Count Sequence Diagram](Sequence Diagrams/EmailAttachmentsController/EmailAttachmentCountSequenceDiagram.png)
  - [Email Attachment Details Sequence Diagram](Sequence Diagrams/EmailAttachmentsController/EmailAttachmentDetailsSequenceDiagram.png)
  - [Add Email Attachments Sequence Diagram](Sequence Diagrams/EmailAttachmentsController/AddEmailAttachmentsSequenceDiagram.png)
  - [Edit Email Attachment Sequence Diagram](Sequence Diagrams/EmailAttachmentsController/EditEmailAttachmentSequenceDiagram.png)
  - [Edit Email Attachment File Sequence Diagram](Sequence Diagrams/EmailAttachmentsController/EditEmailAttachmentFileSequenceDiagram.png)
  - [Edit Email Attachment Property Sequence Diagram](Sequence Diagrams/EmailAttachmentsController/EditEmailAttachmentPropertySequenceDiagram.png)
  - [Delete Email Attachments Sequence Diagram](Sequence Diagrams/EmailAttachmentsController/DeleteEmailAttachmentsSequenceDiagram.png)
  - [Delete Email Attachment Sequence Diagram](Sequence Diagrams/EmailAttachmentsController/DeleteEmailAttachmentSequenceDiagram.png)
  - [Export Email Attachment Sequence Diagram](Sequence Diagrams/EmailAttachmentsController/ExportEmailAttachmentSequenceDiagram.png)

**Unit Tests**

- Positive Test Cases: N/A
- Negative Test Cases: N/A